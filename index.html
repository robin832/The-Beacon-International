<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Beacon International | Live Survey Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    body {
      margin: 0;
      background-color: #1c1c1c;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, PieChart, Pie } = Recharts;

    // Design tokens
    const COLORS = {
      bg: '#1c1c1c',
      cardBg: '#232323',
      border: '#333333',
      accent: '#3ecf8e',
      accentDark: '#2da06b',
      textPrimary: '#ffffff',
      textSecondary: '#888888',
      textMuted: '#666666'
    };

    // Opportunity configuration
    const OPPORTUNITIES = {
      "Viva Tech Paris (June)": { short: "Viva Tech Paris", color: "#FF6B6B", flag: "FR" },
      "Smart City World Expo Barcelona (November)": { short: "Smart City Barcelona", color: "#4ECDC4", flag: "ES" },
      "Slush Helsinki (November)": { short: "Slush Helsinki", color: "#45B7D1", flag: "FI" },
      "Hannover Messe (April)": { short: "Hannover Messe", color: "#96CEB4", flag: "DE" },
      "Drone Summit Riga (May)": { short: "Drone Summit Riga", color: "#F9CA24", flag: "LV" },
      "Upstream Festival Rotterdam (May)": { short: "Upstream Rotterdam", color: "#A29BFE", flag: "NL" },
      "Possidonia Athens (June)": { short: "Possidonia Athens", color: "#00B894", flag: "GR" },
      "FIT Ports & Trade Mission Malaysia (September)": { short: "FIT Malaysia", color: "#E17055", flag: "MY" }
    };

    function App() {
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [viewMode, setViewMode] = useState('pie');
      const [isRefreshing, setIsRefreshing] = useState(false);
      const [totalResponses, setTotalResponses] = useState(0);
      const [showCompanies, setShowCompanies] = useState(true);

      const fetchData = useCallback(async () => {
        setIsRefreshing(true);

        try {
          const response = await fetch('/api/survey-data');

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          const items = result.items || [];
          setTotalResponses(items.length);

          // Aggregate data
          const counts = {};
          Object.keys(OPPORTUNITIES).forEach(name => {
            counts[name] = { count: 0, companies: [] };
          });

          items.forEach(item => {
            const opportunities = item.opportunities || [];
            opportunities.forEach(opp => {
              const oppName = opp.trim();
              if (counts[oppName]) {
                counts[oppName].count++;
                if (item.consent && item.company) {
                  counts[oppName].companies.push(item.company);
                }
              }
            });
          });

          // Convert to chart data
          const chartData = Object.entries(OPPORTUNITIES).map(([fullName, info]) => ({
            name: info.short,
            fullName: fullName,
            count: counts[fullName]?.count || 0,
            companies: counts[fullName]?.companies || [],
            color: info.color,
            flag: info.flag
          }));

          chartData.sort((a, b) => b.count - a.count);
          setData(chartData);
          setLastUpdated(new Date());
          setError(null);

        } catch (err) {
          console.error('Fetch error:', err);
          setError(err.message);
        } finally {
          setLoading(false);
          setIsRefreshing(false);
        }
      }, []);

      useEffect(() => {
        fetchData();
        const interval = setInterval(fetchData, 15000);
        return () => clearInterval(interval);
      }, [fetchData]);

      // Calculate stats
      const totalInterests = data.reduce((sum, d) => sum + d.count, 0);
      const topEvent = data.length > 0 ? data[0] : null;
      const uniqueCompanies = new Set(data.flatMap(d => d.companies)).size;

      const CustomTooltip = ({ active, payload }) => {
        if (active && payload && payload.length) {
          const d = payload[0].payload;
          return (
            <div style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }} className="p-4 rounded-lg max-w-xs">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-xs font-medium px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.border, color: COLORS.textSecondary }}>{d.flag}</span>
                <p className="font-medium text-white text-sm">{d.fullName}</p>
              </div>
              <p className="text-2xl font-semibold mb-3" style={{ color: COLORS.accent }}>{d.count} interested</p>
              {showCompanies && d.companies.length > 0 && (
                <div className="border-t pt-3" style={{ borderColor: COLORS.border }}>
                  <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>Companies interested:</p>
                  <div className="flex flex-wrap gap-1">
                    {d.companies.map((company, idx) => (
                      <span key={idx} className="text-xs px-2 py-1 rounded" style={{ backgroundColor: COLORS.border, color: COLORS.textSecondary }}>
                        {company}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          );
        }
        return null;
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: COLORS.bg }}>
            <div className="text-center">
              <div className="w-8 h-8 border-2 rounded-full animate-spin mx-auto mb-4" style={{ borderColor: COLORS.border, borderTopColor: COLORS.accent }}></div>
              <p style={{ color: COLORS.textSecondary }}>Loading survey results...</p>
            </div>
          </div>
        );
      }

      const maxCount = Math.max(...data.map(d => d.count), 1);

      return (
        <div className="min-h-screen p-4 md:p-6" style={{ backgroundColor: COLORS.bg }}>
          <div className="max-w-7xl mx-auto">

            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-4">
                <img
                  src="./The Beacon_logo_1 colour txt R_white.png"
                  alt="The Beacon"
                  className="h-10"
                />
                <p className="text-sm" style={{ color: COLORS.textMuted }}>Live survey results</p>
              </div>

              <div className="flex items-center gap-2">
                {lastUpdated && (
                  <span className="text-xs" style={{ color: COLORS.textMuted }}>
                    Updated {lastUpdated.toLocaleTimeString()}
                  </span>
                )}
                <button
                  onClick={fetchData}
                  disabled={isRefreshing}
                  className="p-2 rounded-lg transition-colors disabled:opacity-50"
                  style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}
                >
                  <svg className={`w-4 h-4 ${isRefreshing ? 'animate-spin' : ''}`} style={{ color: COLORS.textSecondary }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
              </div>
            </div>

            {error && (
              <div className="mb-6 px-4 py-3 rounded-lg text-sm" style={{ backgroundColor: '#3d2020', border: '1px solid #5c3030', color: '#ff8080' }}>
                {error}
              </div>
            )}

            {/* Stats Bar - 4 Metric Cards */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div className="rounded-lg p-4" style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}>
                <p className="text-xs font-medium mb-1" style={{ color: COLORS.textMuted }}>Total Responses</p>
                <p className="text-2xl font-semibold text-white">{totalResponses}</p>
              </div>
              <div className="rounded-lg p-4" style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}>
                <p className="text-xs font-medium mb-1" style={{ color: COLORS.textMuted }}>Total Interests</p>
                <p className="text-2xl font-semibold" style={{ color: COLORS.accent }}>{totalInterests}</p>
              </div>
              <div className="rounded-lg p-4" style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}>
                <p className="text-xs font-medium mb-1" style={{ color: COLORS.textMuted }}>Top Event</p>
                <p className="text-lg font-semibold text-white truncate">{topEvent?.name || '-'}</p>
              </div>
              <div className="rounded-lg p-4" style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}>
                <p className="text-xs font-medium mb-1" style={{ color: COLORS.textMuted }}>Companies</p>
                <p className="text-2xl font-semibold text-white">{uniqueCompanies}</p>
              </div>
            </div>

            {/* Controls */}
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-2 p-1 rounded-full" style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}>
                <button
                  onClick={() => setViewMode('pie')}
                  className="px-4 py-1.5 rounded-full text-sm font-medium transition-all"
                  style={{
                    backgroundColor: viewMode === 'pie' ? COLORS.accent : 'transparent',
                    color: viewMode === 'pie' ? COLORS.bg : COLORS.textSecondary
                  }}
                >
                  Pie
                </button>
                <button
                  onClick={() => setViewMode('bar')}
                  className="px-4 py-1.5 rounded-full text-sm font-medium transition-all"
                  style={{
                    backgroundColor: viewMode === 'bar' ? COLORS.accent : 'transparent',
                    color: viewMode === 'bar' ? COLORS.bg : COLORS.textSecondary
                  }}
                >
                  Bar
                </button>
              </div>

              <button
                onClick={() => setShowCompanies(!showCompanies)}
                className="px-4 py-1.5 rounded-full text-sm font-medium transition-all"
                style={{
                  backgroundColor: showCompanies ? COLORS.accent : COLORS.cardBg,
                  color: showCompanies ? COLORS.bg : COLORS.textSecondary,
                  border: `1px solid ${showCompanies ? COLORS.accent : COLORS.border}`
                }}
              >
                {showCompanies ? 'Hide' : 'Show'} Companies
              </button>
            </div>

            {/* Main Content - 2 Column Layout */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

              {/* Chart - Left Column (2/3 width) */}
              <div className="lg:col-span-2 rounded-lg p-6" style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}>
                {viewMode === 'bar' ? (
                  <div style={{ height: '400px' }}>
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart
                        data={data}
                        layout="vertical"
                        margin={{ top: 10, right: 30, left: 10, bottom: 10 }}
                      >
                        <XAxis type="number" domain={[0, maxCount + 1]} stroke={COLORS.textMuted} tick={{ fill: COLORS.textMuted }} />
                        <YAxis
                          type="category"
                          dataKey="name"
                          width={140}
                          tick={{ fill: COLORS.textSecondary, fontSize: 12 }}
                        />
                        <Tooltip content={<CustomTooltip />} />
                        <Bar dataKey="count" radius={[0, 4, 4, 0]} animationDuration={800}>
                          {data.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.color} />
                          ))}
                        </Bar>
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                ) : (
                  <div style={{ height: '400px' }}>
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={data.filter(d => d.count > 0)}
                          dataKey="count"
                          nameKey="name"
                          cx="50%"
                          cy="50%"
                          outerRadius={140}
                          innerRadius={70}
                          paddingAngle={2}
                        >
                          {data.filter(d => d.count > 0).map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.color} />
                          ))}
                        </Pie>
                        <Tooltip content={<CustomTooltip />} />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                )}
              </div>

              {/* Legend - Right Column (1/3 width) */}
              <div className="rounded-lg p-4" style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}>
                <h3 className="text-sm font-medium mb-4" style={{ color: COLORS.textMuted }}>Events</h3>
                <div className="space-y-3">
                  {data.map((item) => (
                    <div key={item.fullName} className="flex items-center justify-between">
                      <div className="flex items-center gap-3 min-w-0">
                        <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: item.color }}></div>
                        <div className="min-w-0">
                          <p className="text-sm font-medium text-white truncate">{item.name}</p>
                          <p className="text-xs truncate" style={{ color: COLORS.textMuted }}>{item.flag}</p>
                        </div>
                      </div>
                      <span className="text-lg font-semibold ml-2" style={{ color: item.color }}>{item.count}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Detailed Cards - Below */}
            {showCompanies && (
              <div className="mt-6">
                <h3 className="text-sm font-medium mb-4" style={{ color: COLORS.textMuted }}>Company Details</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {data.filter(item => item.companies.length > 0).map((item) => (
                    <div
                      key={item.fullName}
                      className="rounded-lg p-4"
                      style={{ backgroundColor: COLORS.cardBg, border: `1px solid ${COLORS.border}` }}
                    >
                      <div className="flex items-center gap-3 mb-3">
                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }}></div>
                        <p className="font-medium text-white text-sm">{item.fullName}</p>
                        <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.border, color: COLORS.textSecondary }}>{item.flag}</span>
                      </div>
                      <div className="flex flex-wrap gap-1">
                        {item.companies.map((company, idx) => (
                          <span key={idx} className="text-xs px-2 py-1 rounded" style={{ backgroundColor: COLORS.border, color: COLORS.textSecondary }}>
                            {company}
                          </span>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Footer */}
            <div className="text-center mt-8 text-sm" style={{ color: COLORS.textMuted }}>
              <p>
                <a
                  href="https://forms.monday.com/forms/952d3df894af793199474c6caf6b4199"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="hover:underline"
                  style={{ color: COLORS.accent }}
                >
                  Submit your interest
                </a>
              </p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
